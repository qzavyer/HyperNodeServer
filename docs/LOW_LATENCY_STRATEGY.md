# ‚ö° LOW LATENCY Strategy - Stay Current with File Growth

## –ü—Ä–æ–±–ª–µ–º–∞

### –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å–ø–µ—Ç—å –∑–∞ —Ä–æ—Å—Ç–æ–º —Ñ–∞–π–ª–∞
```
–°–∫–æ—Ä–æ—Å—Ç—å —Ä–æ—Å—Ç–∞ —Ñ–∞–π–ª–∞:  ~315,000 —Å—Ç—Ä–æ–∫/—Å–µ–∫—É–Ω–¥—É
–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:     ~16,000 —Å—Ç—Ä–æ–∫/—Å–µ–∫—É–Ω–¥—É
–†–∞–∑–Ω–∏—Ü–∞:                x20 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ!

–†–µ–∑—É–ª—å—Ç–∞—Ç: Buffer —Ä–∞—Å—Ç—ë—Ç –æ—Ç 3.5M –¥–æ 4M+ —Å—Ç—Ä–æ–∫
          –û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
          –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –Ω–∞ –º–∏–Ω—É—Ç—ã/—á–∞—Å—ã
```

### –°—Ç–∞—Ä–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (NO DATA LOSS):
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –í–°–ï —Å—Ç—Ä–æ–∫–∏
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: **–í–µ—á–Ω–æ–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ**

### –ù–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (LOW LATENCY):
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –°–í–ï–ñ–ò–ï —Å—Ç—Ä–æ–∫–∏
- –ú–æ–∂–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: **–û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ 1-2 —Å–µ–∫—É–Ω–¥—ã –º–∞–∫—Å–∏–º—É–º**

---

## –†–µ—à–µ–Ω–∏–µ

### 1. Aggressive Buffer Limit (CRITICAL!)

```python
MAX_BATCH_SIZE = 200000        # Process up to 200K per batch
CRITICAL_BUFFER_SIZE = 500000  # Critical threshold

if buffer_size > CRITICAL_BUFFER_SIZE:
    # DROP old data, keep RECENT
    dropped = buffer_size - MAX_BATCH_SIZE
    lines_to_process = lines_to_process[-MAX_BATCH_SIZE:]  # Last 200K only!
    logger.error(f"üö® Dropped {dropped:,} old lines to stay current")
```

**–õ–æ–≥–∏–∫–∞:**
- Buffer ‚â§500K: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å—ë (–æ—á–µ—Ä–µ–¥—å)
- Buffer >500K: **–°–ë–†–ê–°–´–í–ê–ï–ú —Å—Ç–∞—Ä—ã–µ**, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200K

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ **–ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç** 500K —Å—Ç—Ä–æ–∫
- –ü—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ 315K/sec = **1.6 —Å–µ–∫—É–Ω–¥—ã –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è –º–∞–∫—Å–∏–º—É–º** ‚úÖ

---

### 2. Increased Workers (4 ‚Üí 8-16)

```python
# Before: available_cores // 4 = 1-2 workers
# After:  available_cores // 2 = 4-8 workers

self.parallel_workers = max(4, min(16, available_cores // 2))
```

**–†–∞—Å—á—ë—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- 4 workers: ~16K —Å—Ç—Ä–æ–∫/—Å–µ–∫
- 8 workers: ~32K —Å—Ç—Ä–æ–∫/—Å–µ–∫  
- 16 workers: ~64K —Å—Ç—Ä–æ–∫/—Å–µ–∫

**–í—Å—ë –µ—â—ë –º–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º —Ä–æ—Å—Ç —Ñ–∞–π–ª–∞ (315K/—Å–µ–∫), –ù–û:**
- –° aggressive buffer limit –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–≤–µ–∂–∏–µ

---

### 3. Increased Batch Size (100K ‚Üí 200K)

```python
MAX_BATCH_SIZE = 200000  # Doubled
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ú–µ–Ω—å—à–µ overhead –Ω–∞ batch creation
- –ë–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫ –∑–∞ –æ–¥–∏–Ω —Ü–∏–∫–ª
- ~2x throughput

---

### 4. Reduced Log Spam

–£–±—Ä–∞–Ω—ã:
- ‚ùå `Added X lines to buffer` (–∫–∞–∂–¥—ã–µ 1000) - –∑–∞—Å–æ—Ä—è–ª–∏ –ª–æ–≥–∏
- ‚ùå `Parsing line X` (–∫–∞–∂–¥—ã–µ 1000) - –Ω–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ
- ‚ùå `OrderExtractor stats` (–∫–∞–∂–¥—ã–µ 1000) - —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ

–û—Å—Ç–∞–≤–ª–µ–Ω—ã:
- ‚úÖ `Global lines processed` (–∫–∞–∂–¥—ã–µ 10000) - –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- ‚úÖ `Worker progress` (–∫–∞–∂–¥—ã–µ 1000) - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∞–Ω–∏–π
- ‚úÖ `OrderExtractor stats` (–∫–∞–∂–¥—ã–µ 50000) - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (Buffer <200K):
```
üì¶ Processing batch: 25352 lines
üîÑ Parallel: 8 workers (LOW LATENCY mode)
‚úÖ Parallel COMPLETED: 25352 ‚Üí 19790 orders
üì° WebSocket: 19790 orders
```

### –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (Buffer 200K-500K):
```
‚ö†Ô∏è Large buffer: 350000 lines, limiting to 200000
üì¶ Processing batch: 200000 lines, 150000 queued
...
‚úÖ Parallel COMPLETED: 200000 ‚Üí 156000 orders
```

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (Buffer >500K):
```
üö® CRITICAL buffer overflow: 3,586,539 lines!
‚ö†Ô∏è Dropping 3,386,539 old lines to prevent lag
üì¶ Processing RECENT batch: 200,000 lines
...
‚úÖ Parallel COMPLETED: 200000 ‚Üí 156000 orders
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –°–í–ï–ñ–ò–ï –æ—Ä–¥–µ—Ä–∞, –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ <2 —Å–µ–∫—É–Ω–¥!

---

## –û–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### ‚úÖ –£—Å–ø–µ—Ö (LOW LATENCY —Ä–∞–±–æ—Ç–∞–µ—Ç):

**Buffer size —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:**
```
Buffer: 450K ‚Üí 200K ‚Üí 250K ‚Üí 200K ‚Üí 300K ‚Üí 200K
–ö–æ–ª–µ–±–ª–µ—Ç—Å—è –æ–∫–æ–ª–æ 200-300K, –Ω–µ —Ä–∞—Å—Ç—ë—Ç –ª–∏–Ω–µ–π–Ω–æ!
```

**Processing throughput:**
```
Workers: 8-16 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ CPU)
Throughput: 32-64K —Å—Ç—Ä–æ–∫/—Å–µ–∫
Latency: 1-2 —Å–µ–∫—É–Ω–¥—ã –æ—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```

**Dropped lines (–¥–æ–ø—É—Å—Ç–∏–º–æ!):**
```
üö® CRITICAL buffer overflow: 650K lines
‚ö†Ô∏è Dropping 450K old lines
(–≠—Ç–æ –ù–û–†–ú–ê–õ–¨–ù–û –ø—Ä–∏ burst –Ω–∞–≥—Ä—É–∑–∫–µ!)
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ (–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç):

**Buffer –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞—Å—Ç–∏:**
```
Buffer: 500K ‚Üí 1M ‚Üí 2M ‚Üí 5M ‚Üí 10M
Aggressive limit –ù–ï —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç!
```

---

## Trade-offs

### –ß—Ç–æ –¢–ï–†–Ø–ï–ú:
- ‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –æ—Ä–¥–µ—Ä–∞ (–ø—Ä–∏ buffer >500K)
- ‚ùå –ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ burst –Ω–∞–≥—Ä—É–∑–∫–µ

### –ß—Ç–æ –ü–û–õ–£–ß–ê–ï–ú:
- ‚úÖ –û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ <2 —Å–µ–∫—É–Ω–¥—ã (–±—ã–ª–æ: –º–∏–Ω—É—Ç—ã/—á–∞—Å—ã)
- ‚úÖ –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å (buffer ‚â§500K)
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ LOW LATENCY —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# Buffer sizes (–¥–æ–ª–∂–Ω—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è)
docker logs hyperliquid-parser -f 2>&1 | grep -E "üì¶ Processing|üö® CRITICAL"

# Workers (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 8-16, –Ω–µ 4)
docker logs hyperliquid-parser --tail=50 | grep "‚ö° LOW LATENCY mode"

# Dropped lines (–¥–æ–ø—É—Å—Ç–∏–º–æ –ø—Ä–∏ burst)
docker logs hyperliquid-parser -f 2>&1 | grep "Dropping.*old lines"

# WebSocket (–¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ)
docker logs hyperliquid-parser -f 2>&1 | grep "üì° WebSocket"
```

---

## Configuration

### Environment Variables (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å):

```env
# –£–≤–µ–ª–∏—á–∏—Ç—å workers (–µ—Å–ª–∏ CPU –ø–æ–∑–≤–æ–ª—è–µ—Ç)
MAX_WORKERS_AUTO=true  # Auto-detect

# –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
TAIL_PARALLEL_WORKERS=16  # –ï—Å–ª–∏ MAX_WORKERS_AUTO=false
```

### Hard-coded Limits (–≤ –∫–æ–¥–µ):

```python
MAX_BATCH_SIZE = 200000        # –ú–∞–∫—Å –∑–∞ —Ä–∞–∑
CRITICAL_BUFFER_SIZE = 500000  # –ü–æ—Ä–æ–≥ —Å–±—Ä–æ—Å–∞
```

**–ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –µ—Å–ª–∏:**
- –ë–æ–ª—å—à–µ CPU cores (32+)
- –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ per batch
- –ì–æ—Ç–æ–≤—ã –∫ –±–æ–ª—å—à–µ–º—É –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—é (–Ω–æ <5 —Å–µ–∫—É–Ω–¥)

---

## Performance Impact

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| Workers | 4 | 8-16 | +2-4x |
| Batch size | 100K | 200K | +2x |
| Throughput | 16K/s | 32-64K/s | +2-4x |
| Max lag | Infinity | 1.6s | ‚úÖ FIXED |
| Data loss | 0% | <1% (burst) | Acceptable |

---

## –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Buffer —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–∫–æ–ª–æ 200-400K
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ `üì° WebSocket` —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò–Ω–æ–≥–¥–∞ `üö® CRITICAL` –ø—Ä–∏ burst (–ù–û–†–ú–ê–õ–¨–ù–û!)
- –û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ <2 —Å–µ–∫—É–Ω–¥

