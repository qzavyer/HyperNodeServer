# Техническое задание: Система очистки файлов HyperLiquid Node

## Назначение

Система очистки файлов предназначена для автоматического управления дисковым пространством на серверах HyperLiquid Node путем удаления устаревших файлов согласно заданным правилам. Система обеспечивает сохранение критически важных данных при освобождении места на диске.

## Общие требования

### Место выполнения
- Система должна выполняться на серверах HyperLiquid Node
- Обработка файлов производится локально на каждом узле
- Поддерживается работа в контейнерах Docker

### Периодичность выполнения
- Автоматический запуск каждый 1 час
- Возможность ручного запуска через API или CLI
- Поддержка dry-run режима для тестирования

### Ограничения
- Максимальное время выполнения: 30 минут
- Логирование всех операций удаления
- Откат изменений невозможен после удаления
- Проверка доступного места на диске перед выполнением

## Правила очистки по путям

### Временные директории

#### `/home/hl/hl/tmp/fu_write_string_to_file_tmp/`
- **Правило**: Оставлять файлы не старше 2 дней от последней даты в именах файлов
- **Формат имени**: `YYYY-MM-DD_HH:MM:SS.*`
- **Критерий**: Сортировка по дате в имени файла, удаление файлов старше 2 дней

#### `/home/hl/hl/tmp/shell_rs_out/`
- **Правило**: Оставлять файлы не старше 2 дней от последней даты в именах файлов
- **Формат имени**: `YYYY-MM-DD_HH:MM:SS.*`
- **Критерий**: Сортировка по дате в имени файла, удаление файлов старше 2 дней

### База данных и обмен

#### `/home/hl/hl/hyperliquid_data/db_hub/Exchange/`
- **Правило**: Оставлять последние 100 файлов
- **Формат имени**: `\d+.log`
- **Критерий**: Сортировка по имени файла (числовому), удаление старых файлов

### Статистика критических сообщений

#### `/home/hl/hl/data/crit_msg_stats/hl-node/`
- **Правило**: Оставлять последние 30 файлов
- **Формат имени**: `yyyyMMdd`
- **Критерий**: Сортировка по дате в имени файла

#### `/home/hl/hl/data/crit_msg_stats/hl-visor/`
- **Правило**: Оставлять последние 30 файлов
- **Формат имени**: `yyyyMMdd`
- **Критерий**: Сортировка по дате в имени файла

### Данные DHS (Data Hub Service)

#### `/home/hl/hl/data/dhs/EvmBlockNumbers/hourly/`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/dhs/EvmBlocks/hourly/`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/dhs/EvmTxs/hourly/`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/evm_block_and_receipts/hourly/`
- **Правило**: Поведение как для `node_order_statuses/hourly`
- **Критерий**: Сортировка по времени создания

### Метрики задержек

#### `/home/hl/hl/data/latency_buckets/bucket_guard/*/hourly`
- **Правило**: Поведение как для `node_order_statuses/hourly`
- **Критерий**: Обработка всех поддиректорий первого уровня

#### `/home/hl/hl/data/latency_buckets/*/hourly`
- **Правило**: Поведение как для `node_order_statuses/hourly`
- **Критерий**: Обработка всех поддиректорий первого уровня

### Логи и данные узлов

#### `/home/hl/hl/data/log/*/*/`
- **Правило**: Оставлять только 3 последних файла
- **Формат имени**: `yyyyMMdd`
- **Критерий**: Сортировка по дате в имени файла

#### `/home/hl/hl/data/node_fast_block_times/`
- **Правило**: Оставлять только 3 последних файла
- **Формат имени**: `yyyyMMdd`
- **Критерий**: Сортировка по дате в имени файла

#### `/home/hl/hl/data/node_logs/*/hourly`
- **Правило**: Оставлять последние 10 файлов в порядке времени
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/node_slow_block_times/`
- **Правило**: Оставлять только 3 последних файла
- **Критерий**: Сортировка по времени создания

### Периодические данные

#### `/home/hl/hl/data/periodic_abci_state_statuses/20251014`
- **Правило**: Оставлять 3 последних папки
- **Критерий**: Сортировка по времени создания директории

#### `/home/hl/hl/data/rate_limited_ips/*/hourly`
- **Правило**: Оставлять последние 10 файлов в порядке времени
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/tcp_lz4_stats/20250914`
- **Правило**: Оставлять 3 последних файла
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/tcp_traffic/hourly`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/tokio_spawn_forever_metrics/hourly`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/visor_abci_states/hourly`
- **Правило**: Оставлять последние 10 файлов
- **Критерий**: Сортировка по времени создания

#### `/home/hl/hl/data/visor_child_stderr/`
- **Правило**: Оставлять 3 последних папки
- **Формат имени**: `yyyyMMdd`
- **Критерий**: Сортировка по дате в имени директории

## Требования к реализации

### Технологический стек
- **Язык программирования**: Python 3.8+
- Использовать для реализации имеющийся класс `DirectoryCleaner`

### Обработка ошибок
- Логирование всех операций с уровнем DEBUG
- Обработка исключений доступа к файлам
- Продолжение работы при ошибках в отдельных директориях
- Уведомления об ошибках через систему мониторинга

### Dry-run режим
- Предварительный просмотр операций без фактического удаления
- Детальный отчет о файлах, подлежащих удалению
- Оценка освобождаемого места на диске
- Валидация правил очистки

### Отчетность
- Алерты при превышении лимитов времени выполнения

## Примеры сценариев

### Сценарий 1: Очистка временных файлов
**Исходное состояние**: `/home/hl/hl/tmp/fu_write_string_to_file_tmp/` содержит 50 файлов
**Дата последнего файла**: `2024-01-15_14:30:00.log`
**Текущая дата**: `2024-01-17_10:00:00`
**Результат**: Удаляются файлы старше `2024-01-15_10:00:00`, остается 12 файлов

### Сценарий 2: Очистка логов по количеству
**Исходное состояние**: `/home/hl/hl/data/crit_msg_stats/hl-node/` содержит 45 файлов
**Формат имен**: `20240101`, `20240102`, ..., `20240115`
**Результат**: Удаляются файлы `20240101` - `20240112`, остается 30 файлов

### Сценарий 3: Очистка директорий
**Исходное состояние**: `/home/hl/hl/data/visor_child_stderr/` содержит 8 директорий
**Формат имен**: `20240101`, `20240102`, ..., `20240108`
**Результат**: Удаляются директории `20240101` - `20240105`, остается 3 директории

### Сценарий 4: Обработка ошибок доступа
**Проблема**: Нет доступа к директории `/home/hl/hl/data/restricted/`
**Действие**: Логирование ошибки, продолжение обработки других директорий
**Результат**: Остальные директории обрабатываются нормально

## Критерии приемки

1. **Функциональность**: Все правила очистки работают согласно спецификации
2. **Производительность**: Обработка всех директорий завершается за время не более 30 минут
3. **Надежность**: Система продолжает работу при ошибках в отдельных директориях
4. **Безопасность**: Dry-run режим предотвращает случайное удаление файлов
5. **Мониторинг**: Все операции логируются с достаточной детализацией
